---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Login">
  <main
    class="flex min-h-screen flex-col items-center justify-center p-6 bg-black"
  >
    <div class="w-full max-w-md">
      <div class="text-center mb-10">
        <h1 class="text-3xl font-bold text-white mb-2">Welcome Back</h1>
        <p class="text-gray-500">Sign in to access exclusive content.</p>
      </div>

      <form class="space-y-6" id="login-form">
        <div class="space-y-4">
          <div>
            <label
              for="email"
              class="block text-sm font-medium text-gray-400 mb-1"
              >Email address</label
            >
            <input
              id="email"
              name="email"
              type="email"
              required
              class="block w-full px-4 py-3 bg-neutral-900 border border-neutral-800 text-white rounded focus:outline-none focus:border-[#ff208a] focus:ring-1 focus:ring-[#ff208a] transition-colors placeholder-gray-600"
              placeholder="you@example.com"
            />
          </div>
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-gray-400 mb-1"
              >Password</label
            >
            <input
              id="password"
              name="password"
              type="password"
              required
              class="block w-full px-4 py-3 bg-neutral-900 border border-neutral-800 text-white rounded focus:outline-none focus:border-[#ff208a] focus:ring-1 focus:ring-[#ff208a] transition-colors placeholder-gray-600"
              placeholder="••••••••"
            />
          </div>
        </div>

        <div>
          <button
            type="submit"
            class="w-full flex justify-center py-3 px-4 border border-transparent text-sm font-bold rounded text-white bg-[#ff208a] hover:bg-[#ff208a]/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#ff208a] transition-all"
          >
            Sign in
          </button>
        </div>
      </form>

      <div
        id="message"
        class="text-center text-sm text-red-500 mt-4 min-h-[1.25rem]"
      >
      </div>

      <div class="text-center text-sm mt-8 border-t border-neutral-900 pt-8">
        <p class="text-gray-500">
          Don't have an account?
          <a
            href="/signup"
            class="font-medium text-[#ff208a] hover:text-white transition-colors ml-1"
            >Sign up</a
          >
        </p>
      </div>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from "../lib/supabase";

  const form = document.querySelector("#login-form") as HTMLFormElement;
  const messageElement = document.querySelector("#message") as HTMLDivElement;

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const email = formData.get("email") as string;
      const password = formData.get("password") as string;

      messageElement.textContent = "Signing in...";

      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        messageElement.textContent = error.message;
      } else {
        // Set cookies for middleware
        document.cookie = `sb-access-token=${data.session.access_token}; path=/; max-age=${data.session.expires_in}; SameSite=Lax; Secure`;
        document.cookie = `sb-refresh-token=${data.session.refresh_token}; path=/; max-age=${data.session.expires_in}; SameSite=Lax; Secure`;
        window.location.href = "/"; // Go to home instead of /exclusive since we don't have a dedicated page for it yet, or listing page is fine
      }
    });
  }
</script>
